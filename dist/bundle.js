// ==UserScript==
// @name         On Canvas Plus
// @namespace    http://tampermonkey.net/
// @version      2025-10-03
// @description  Shows grade changes on the courses pages. Requires BetterCanvas.
// @author       David Callender
// @include      /^https:\/\/canvas\.[^\/]+\.edu\/.*/
// @grant        none
// ==/UserScript==

(()=>{var e={839(e){e.exports="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 27.777 36.514' version='1.0'%3e%3cdefs%3e%3clinearGradient id='prefix__a' x1='-155.74' gradientUnits='userSpaceOnUse' y1='558.8' gradientTransform='matrix(0 -1.6732 1.1476 0 -269.01 -124.96)' x2='-171.94' y2='541.27'%3e%3cstop stop-color='%2380ff26' offset='0'/%3e%3cstop stop-color='%232c9600' offset='1'/%3e%3c/linearGradient%3e%3c/defs%3e%3cpath stroke-linejoin='round' d='M348.77 146.39h5.34v20.89h15.3v-20.89h5.38l-13.03-13.87-12.99 13.87z' stroke='%23116b1c' stroke-width='1.75' fill='url(%23prefix__a)' color='%23000' transform='translate(-347.89 -131.64)'/%3e%3c/svg%3e"},943(e){e.exports="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 27.777 36.514' version='1.0'%3e%3cdefs%3e%3clinearGradient id='prefix__a' x1='155.51' gradientUnits='userSpaceOnUse' y1='-459.75' gradientTransform='matrix(0 1.6732 -1.1476 0 -237.29 -184.28)' x2='173.43' y2='-440.71'%3e%3cstop stop-color='%23ff2a26' offset='0'/%3e%3cstop stop-color='%2396000d' offset='1'/%3e%3c/linearGradient%3e%3c/defs%3e%3cpath stroke-linejoin='round' d='M292.55 94.867h-5.35V73.971h-15.29v20.896h-5.38l13.03 13.873 12.99-13.873z' stroke='%236b1a11' stroke-width='1.75' fill='url(%23prefix__a)' color='%23000' transform='translate(-265.65 -73.096)'/%3e%3c/svg%3e"}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var a=t[o]={exports:{}};return e[o](a,a.exports,r),a.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";const e="OCP_grades",t="OCP_hotkeys";class o extends Error{constructor(r){alert("OCP: Something has gone wrong. See the developer console for more information."),localStorage.removeItem(e),localStorage.removeItem(t),console.error("OCP Error vvv"),super(r)}}const n=e=>{console.log("OCP: "+e)},a=e=>new Promise(t=>setTimeout(t,e));class s{constructor(e,t){this.location=e;const r=localStorage.getItem(e);if(null===r)return localStorage.setItem(e,JSON.stringify(t)),void(this.value=t);try{this.value=JSON.parse(r)}catch(e){throw new o(`Failed to parse localStorage value. Original error: ${String(e)}`)}}get(){return this.value}set(e){localStorage.setItem(this.location,JSON.stringify(e)),this.value=e}}const i={courses:[],timestamp:void 0},d=(e,t)=>{const r=[];for(const o of e){const e=t.find(({title:e})=>e===o.title);void 0!==e&&e.grade!==o.grade&&r.push({title:o.title,newGrade:o.grade,oldGrade:e.grade})}return r};var c=r(839),l=r.n(c),g=r(943),u=r.n(g);const f=e=>e.newGrade<e.oldGrade?u():l(),h=e=>`${e.toFixed(2)}%`,v=e=>`${e.title} used to be <b>${h(e.oldGrade)}</b>, now it's <b>${h(e.newGrade)}</b>`,m=(e,t,r=!0)=>`${Math.round(e)} ${t}${1===e?"":"s"}${r?" ago":""}`,p=async()=>{if("/"!==globalThis.location.pathname)return;for(n("Grades: running");$(".bettercanvas-card-grade").length<=0;)n("Grades: waiting for grades"),await a(100);const t=$(".bettercanvas-gpa-edit-btn")[0];if(void 0===t)throw new o("Couldn't find GPA button.");t.insertAdjacentHTML("afterend",'<div style="font-size:12px;margin-top:10px" id="gradeChanges"></div> ');(e=>{const t=$("#gradeChanges");if(void 0===e.timeSaved)t.text("Your current grades have been saved. Check back later to see how they have changed.");else{const o=(r=Math.floor((e.now-e.timeSaved)/6e4))<1?"less than a minute ago":r<60?m(r,"minute"):r%60==0?m(r/60,"hour"):`${m((r-r%60)/60,"hour",!1)} and ${m(r%60,"minute")}`;if(0===e.changes.length)return void t.text(`Your grades are the same as the last time you checked ${o}.`);const n=$("<div>").css({"margin-bottom":"10px"});n.text(`Your grades have changed since you last checked ${o}.`),t.append(n)}var r;for(const r of e.changes){const e=$("<div>").css({"margin-bottom":"5px"}),o=$("<img>").attr("src",f(r)).attr("width",14).css({"margin-right":"2px"}),n=$("<span>").html(v(r));e.append(o,n),t.append(e)}})((t=>{const r=new s(e,i),o=r.get(),n=Date.now(),a={changes:d(t,o.courses),now:n,timeSaved:o.timestamp};return r.set({courses:t,timestamp:n}),a})($(".ic-DashboardCard__header").map((e,t)=>({title:$(t).find(".ic-DashboardCard__header-title").text().trim(),grade:Number.parseFloat($(t).find(".bettercanvas-card-grade").text().trim().slice(0,-1))})).filter((e,{grade:t})=>!Number.isNaN(t)).toArray())),n("Grades: done")},w=e=>{switch(e){case"h":return"";case"a":return"assignments";case"d":return"discussion_topics";case"g":return"grades";case"m":return"modules";default:return}};(async()=>{if(n("Main: running"),!0!==globalThis.window.OCP_ran){for(globalThis.window.OCP_ran=!0;"undefined"==typeof jQuery;)n("Main: waiting for jquery"),await a(100);(()=>{n("Hotkeys: running");const e=new s(t,void 0);(async e=>{if("/"!==globalThis.location.pathname)return;for(;$(".ic-DashboardCard__link").length<=0;)n("Hotkeys: waiting for cards"),await a(100);n("Hotkeys: attempting to set hotkeys");const t=$(".ic-DashboardCard__link").toArray().map(e=>{var t;const r=null===(t=e.getAttribute("href"))||void 0===t?void 0:t.split("/").at(-1);if(void 0===r)throw new o("Couldn't find course id");return Number.parseInt(r)}).slice(0,10);if(10===t.length){const e=t.pop();if(void 0===e)return void n("Hotkeys: no hotkeys, exiting");t.unshift(e)}else t.unshift(0);n(`Hotkeys: setting hotkeys to ${JSON.stringify(t)}`),e.set(t)})(e);let r="",i="";const d=()=>{if("z"===i&&"/"!==globalThis.location.pathname)return"/"},c=()=>{const t=(e=>{if(1!==e.length)return;const t=e.codePointAt(0);if(void 0===t)return;const r=t-48;return r>=10?void 0:r})(r),o=w(i);if(void 0===t||void 0===o)return;const a=e.get();if(void 0===a)return void n("Hotkeys: no hotkey map, exiting");const s=`/courses/${a[t]}/${o}`;return n(`Hotkeys: redirecting to ${s}`),s},l=()=>{const e=w(i);if(void 0===e)return;let t;for(const e of globalThis.location.pathname.split("/")){const r=Number.parseInt(e);if(!Number.isNaN(r)){t=r;break}}if(void 0===t)return;const r=`/courses/${t}/${e}`;return n(`Hotkeys: redirecting to ${r}`),r};document.addEventListener("keydown",e=>{const t=document.activeElement;if("INPUT"!==(null==t?void 0:t.tagName)&&"TEXTAREA"!==(null==t?void 0:t.tagName)){r=i,i=e.key;for(const e of[d,c,l]){const t=e();if(null!=t){globalThis.location.pathname=t;break}}}}),n("Hotkeys: done")})(),p(),n("Main: done")}else n("Main: already ran, stopping")})()})()})();